<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas - Cargador Masivo de API</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: #fff;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
        }
        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: monospace;
        }
        textarea#jsonExample { 
            height: auto; 
            min-height: 100px; 
            background-color: #eee;
            border: 1px dashed #aaa;
            color: #000;
            font-size: 14px;
            resize: none; 
            cursor: pointer; 
        }
        textarea#jsonBody {
             font-size: 14px;
             height: 200px;
        }

        button {
            width: 100%;
            padding: 15px;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 4px;
            margin-top: 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        button:hover {
            background-color: #34495e;
        }
        .status, .results {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            background-color: #ecf0f1;
        }
        .error {
            color: #c0392b;
            font-weight: bold;
        }
        #progreso {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        .lista-errores {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #e74c3c;
            background-color: #f9e2e2;
            border-radius: 4px;
        }
        .tooltip-container .tooltiptext {
            visibility: hidden;
            display: none;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Atlas - Cargador Masivo</h1>

    <form id="formularioCarga">
        <label for="cargaType">Tipo de Carga Masiva:</label>
        <select id="cargaType">
            <option value="seguimientos">Seguimientos</option>
            <option value="usuarios">Usuarios</option>
            <option value="documentos">Documentos</option>
            <option value="grupos">Grupos de Ventas</option>
            <option value="fases">Fases</option>
            <option value="origenes">Orígenes</option>
            <option value="tiposSeguimiento">Tipos de Seguimiento</option>
            <option value="motivosDescarte">Motivos de Descarte</option>
            <option value="pisosVenta">Pisos de Venta</option>
            <option value="lineas">Líneas</option>
            <option value="marcas">Marcas</option>
            <option value="etiquetas">Etiquetas</option>
        </select>
        
        <label for="tokenType">Tipo de Token:</label>
        <select id="tokenType">
            <option value="crm">CRM Token</option>
            <option value="sesion">Sesion Token</option>
        </select>
        
        <label for="token" id="tokenLabel">Token del CRM (Token de Integración):</label>
        <input type="text" id="token" placeholder="Ej: P2513DC7FA4..." required>

        <label for="tkSeguimiento">Token de Seguimiento (Opcional):</label>
        <input type="text" id="tkSeguimiento" placeholder="Ej: SEGC-D066B655-31DD...">

        <label for="endpoint">URL del Endpoint (usa {{tkProspecto}} como marcador):</label>
        <input type="url" id="endpoint" placeholder="Ej: https://api.upnify.com/v4/prospectos/{{tkProspecto}}/seguimientos" required>
        
        <label for="metodo">Método HTTP:</label>
        <select id="metodo">
            <option value="POST">POST</option>
            <option value="PUT">PUT</option>
            <option value="PATCH">PATCH</option>
            <option value="DELETE">DELETE</option>
        </select>

        <label for="jsonBody">
            JSON de Carga (Array de Objetos):
            <div class="tooltip-container">
                <span class="info-icon">ⓘ</span>
                <span class="tooltiptext" id="json-example-tooltip"></span>
            </div>
        </label>
        
        <label>Ejemplo JSON (Clic para Copiar):</label>
        <textarea id="jsonExample" readonly></textarea>

        <textarea id="jsonBody" placeholder="[{ 'tkProspecto': '...', 'seguimiento': '...' }, { ... }]"></textarea>

        <button type="submit" id="btnCargar">Iniciar Carga Masiva</button>
    </form>
    
    <div class="status">
        <p id="progreso">Esperando carga...</p>
    </div>
    
    <div class="results" style="display: none;">
        <p><span id="totalItems"></span></p>
        <p>Ítems Fallidos: <span id="itemsFallidosCount" class="error">0</span></p>
        <div id="listaErrores"></div>
    </div>
</div>

<script>
    document.getElementById('formularioCarga').addEventListener('submit', function(e) {
        e.preventDefault();
        iniciarCargaMasiva();
    });

    document.getElementById('tokenType').addEventListener('change', function() {
        const tokenType = this.value;
        const tokenLabel = document.getElementById('tokenLabel');
        const tokenInput = document.getElementById('token');

        if (tokenType === 'crm') {
            tokenLabel.innerText = 'Token del CRM (Token de Integración):';
            tokenInput.placeholder = 'Ej: P2513DC7FA4...';
        } else {
            tokenLabel.innerText = 'Token de Sesión:';
            tokenInput.placeholder = 'Ej: P250DCyMEZGjQtR...';
        }
    });

    // Endpoints y ejemplos JSON para cada tipo de carga
    const endpoints = {
        'seguimientos': 'https://api.upnify.com/v4/prospectos/{{tkProspecto}}/seguimientos',
        'usuarios': 'https://api.upnify.com/v4/usuarios/crear-usuario',
        'documentos': 'https://api.upnify.com/v4/prospectos/{{tkProspecto}}/documentos',
        'grupos': 'https://api.upnify.com/v4/grupos/crear-grupo-venta',
        'fases': 'https://api.upnify.com/v4/fases/crear-fase-proceso-comercial',
        'origenes': 'https://api.upnify.com/v4/origenes/crear-origen',
        'tiposSeguimiento': 'https://api.upnify.com/v4/tipos-seguimiento/crear-tipo-seguimiento',
        'motivosDescarte': 'https://api.upnify.com/v4/motivos-descarte/crear-motivo-descarte',
        'pisosVenta': 'https://api.upnify.com/v4/pisos-venta/crear-piso-venta',
        'lineas': 'https://api.upnify.com/v4/lineas/crear-linea',
        'marcas': 'https://api.upnify.com/v4/marcas/crear-marca',
        'etiquetas': 'https://api.upnify.com/v4/prospectos/{{tkProspecto}}/etiquetas' 
    };

    const jsonExamples = {
        'seguimientos': `[
    {
        "tkProspecto": "P-0A000000-0000-0000-0000-000000000001",
        "seguimiento": "Comentario de prueba",
        "tkTipoSeguimiento": "TSEG-XXXXX" 
    },
    {
        "tkProspecto": "P-0A000000-0000-0000-0000-000000000002",
        "seguimiento": "Otro seguimiento de prueba"
    }
]`,
        'usuarios': `[
    {
        "nombre": "Juan",
        "apellidos": "Perez",
        "correo": "juan.perez@ejemplo.com",
        "contrasena": "password123",
        "esActivo": true
    }
]`,
        'documentos': `[
    {
        "tkProspecto": "P-0A000000-0000-0000-0000-000000000001",
        "nombre": "Documento-1.pdf",
        "archivo": "Base64 del archivo..."
    }
]`,
        'grupos': `[
    {
        "nombre": "Grupo de Ventas México",
        "esActivo": true
    }
]`,
        'fases': `[
    {
        "nombre": "Fase de Contacto",
        "esActivo": true
    }
]`,
        'origenes': `[
    {
        "nombre": "Sitio Web",
        "esActivo": true
    }
]`,
        'tiposSeguimiento': `[
    {
        "nombre": "Llamada",
        "esActivo": true
    }
]`,
        'motivosDescarte': `[
    {
        "nombre": "No le interesa",
        "esActivo": true
    }
]`,
        'pisosVenta': `[
    {
        "nombre": "Piso 1",
        "esActivo": true
    }
]`,
        'lineas': `[
    {
        "nombre": "Línea de Negocio 1",
        "esActivo": true
    }
]`,
        'marcas': `[
    {
        "nombre": "Marca A",
        "esActivo": true
    }
]`,
        // ¡EJEMPLO DE ETIQUETAS CORREGIDO PARA USAR CADENA SEPARADA POR COMAS!
        'etiquetas': `[
    {
        "tkProspecto": "P-0A000000-0000-0000-0000-000000000001",
        "etiquetas": "ETIQ-CA9810BB-...,ETIQ-DF451C6B-...,ETIQ-5233CA3D-...",
        "search_terms": ""
    },
    {
        "tkProspecto": "P-0A000000-0000-0000-0000-000000000002",
        "etiquetas": "ETIQ-OTRA-ETIQUETA",
        "search_terms": ""
    }
]`
    };

    function actualizarCamposDeCarga(tipoSeleccionado) {
        const endpointInput = document.getElementById('endpoint');
        const metodoInput = document.getElementById('metodo');
        const tkSeguimientoField = document.getElementById('tkSeguimiento');
        const tkSeguimientoLabel = document.querySelector('label[for="tkSeguimiento"]');
        
        const jsonExampleText = jsonExamples[tipoSeleccionado] || '[]';
        
        // 1. Actualizar el campo de ejemplo copiable y el tooltip (aunque oculto)
        document.getElementById('jsonExample').value = jsonExampleText;
        document.getElementById('json-example-tooltip').innerText = jsonExampleText;

        // 2. Actualizar el placeholder del campo de carga principal
        // Intentamos parsear el primer objeto del array para el placeholder
        let placeholderText = "";
        try {
            const parsedArray = JSON.parse(jsonExampleText);
            if (parsedArray.length > 0) {
                let placeholderBase = parsedArray[0];
                // Creamos un placeholder que muestre el primer objeto y un objeto vacío
                placeholderText = JSON.stringify([placeholderBase, {}], null, 4);
                // Ajuste visual para el placeholder (opcional)
                placeholderText = placeholderText.substring(1, placeholderText.length - 1).trim().replace(/\n {4}/g, '\n');
            } else {
                placeholderText = "[{ 'tkProspecto': '...', 'datos': '...' }]";
            }
        } catch (e) {
            placeholderText = "[{ 'tkProspecto': '...', 'Error': 'Formato de ejemplo inválido' }]";
        }
        document.getElementById('jsonBody').placeholder = placeholderText;


        // 3. Configurar endpoint, método y campos opcionales
        endpointInput.value = endpoints[tipoSeleccionado] || '';
        
        tkSeguimientoField.style.display = 'none';
        tkSeguimientoLabel.style.display = 'none';

        if (tipoSeleccionado === 'seguimientos') {
            tkSeguimientoField.style.display = 'block';
            tkSeguimientoLabel.style.display = 'block';
            metodoInput.value = 'POST';
        } else if (tipoSeleccionado === 'etiquetas') {
            metodoInput.value = 'PUT'; // Usar PUT para asignar etiquetas
            endpointInput.placeholder = endpoints['etiquetas'].replace('{{tkProspecto}}', 'P-...');
        } else {
            metodoInput.value = 'POST';
        }
    }

    document.getElementById('cargaType').addEventListener('change', function() {
        actualizarCamposDeCarga(this.value);
    });
    
    // Lógica para inicializar al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
        const initialType = document.getElementById('cargaType').value;
        actualizarCamposDeCarga(initialType);
    });

    // Lógica para COPIAR el JSON de ejemplo al hacer click
    document.getElementById('jsonExample').addEventListener('click', function() {
        this.select();
        document.execCommand('copy');
        alert('¡Ejemplo JSON copiado al portapapeles!');
    });

    async function iniciarCargaMasiva() {
        const btnCargar = document.getElementById('btnCargar');
        btnCargar.disabled = true;
        btnCargar.innerText = 'Cargando...';

        document.getElementById('progreso').innerText = 'Iniciando carga...';
        document.getElementById('itemsFallidosCount').innerText = '0';
        document.getElementById('listaErrores').innerHTML = '';
        document.querySelector('.results').style.display = 'none';

        const tokenType = document.getElementById('tokenType').value;
        const tokenInput = document.getElementById('token').value;
        const tkSeguimientoInput = document.getElementById('tkSeguimiento').value;
        const endpointBase = document.getElementById('endpoint').value;
        const metodo = document.getElementById('metodo').value;
        const jsonInput = document.getElementById('jsonBody').value;

        let tokenParaPeticiones = '';
        if (tokenType === 'crm') {
            tokenParaPeticiones = await obtenerSesionToken(tokenInput);
            if (!tokenParaPeticiones) {
                restablecerFormulario();
                return;
            }
        } else {
            tokenParaPeticiones = tokenInput;
        }

        let datos;
        try {
            datos = JSON.parse(jsonInput);
            if (!Array.isArray(datos)) {
                alert('El JSON debe ser un array de objetos.');
                restablecerFormulario();
                return;
            }
        } catch (error) {
            alert('Error al parsear el JSON. Asegúrate de que el formato sea válido.');
            restablecerFormulario();
            return;
        }

        const tamanoLote = 50;
        const totalItems = datos.length;
        let itemsProcesados = 0;
        const itemsFallidos = [];

        for (let i = 0; i < totalItems; i += tamanoLote) {
            const lote = datos.slice(i, i + tamanoLote);
            const promesasLote = lote.map(item => enviarPeticion(endpointBase, tokenParaPeticiones, metodo, item, itemsFallidos, tkSeguimientoInput)); 

            try {
                await Promise.all(promesasLote);
            } catch (error) {
                console.error("Error en el lote: ", error);
            }

            itemsProcesados += lote.length;
            actualizarProgreso(itemsProcesados, totalItems);
        }

        mostrarResultadoFinal(totalItems, itemsFallidos);
        restablecerFormulario();
    }

    async function obtenerSesionToken(crmToken) {
        document.getElementById('progreso').innerText = 'Obteniendo token de sesión...';
        try {
            const respuesta = await fetch('https://api.upnify.com/integraciones/sesion', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Token': crmToken
                }
            });

            const data = await respuesta.json();
            if (!respuesta.ok || data.code !== 0) {
                const errorMsg = data.details || data.msg || 'Error desconocido al obtener el token de sesión.';
                alert(`Error al obtener el token de sesión: ${errorMsg}`);
                return null;
            }
            return data.token;
        } catch (error) {
            alert(`Error de red al obtener el token de sesión: ${error.message}`);
            return null;
        }
    }

    async function enviarPeticion(endpointBase, sesionToken, metodo, item, itemsFallidos, tkSeguimiento) {
        const bodyItem = { ...item };
        let endpointFinal = endpointBase;
        let responseJson = null;
        let responseText = null;

        // 1. Reemplazar {{tkProspecto}} si existe y eliminarlo del body
        if (bodyItem.tkProspecto) {
            endpointFinal = endpointBase.replace('{{tkProspecto}}', bodyItem.tkProspecto);
            delete bodyItem.tkProspecto;
        }
        
        // 2. Lógica para el token de seguimiento opcional (si se aplica)
        if (tkSeguimiento) {
            bodyItem.tkSeguimiento = tkSeguimiento;
        }

        try {
            const respuesta = await fetch(endpointFinal, {
                method: metodo,
                headers: {
                    'Content-Type': 'application/json',
                    'Token': sesionToken 
                },
                body: ['GET', 'DELETE'].includes(metodo.toUpperCase()) ? null : JSON.stringify(bodyItem)
            });

            // Leer la respuesta como texto primero para capturar errores de parseo
            responseText = await respuesta.text();

            // Intentar parsear el JSON si el texto no está vacío
            if (responseText) {
                try {
                    responseJson = JSON.parse(responseText);
                } catch (e) {
                    // Si falla el parseo, responseJson seguirá siendo null y responseText contendrá la respuesta cruda.
                }
            }


            // LÓGICA DE DETECCIÓN DE ERRORES (Punto clave)
            let esFallido = false;
            let errorMsg = "";

            if (!respuesta.ok) {
                // Caso A: Código de estado HTTP no 2xx (400, 500, etc.)
                esFallido = true;
                errorMsg = responseText || respuesta.statusText;
            } else if (responseJson && (responseJson.code !== undefined && responseJson.code !== 0)) {
                // Caso B: Código de estado 200 OK, pero el cuerpo indica un error (Ej: code: 1, msg: "Error de validación")
                esFallido = true;
                errorMsg = responseJson.details || responseJson.msg || responseText;
            } else if (responseJson && responseJson.success === false) {
                 // Caso C: Código de estado 200 OK, pero el cuerpo tiene { success: false }
                esFallido = true;
                errorMsg = responseJson.details || responseJson.msg || responseText;
            }
            
            if (esFallido) {
                itemsFallidos.push({
                    item: item,
                    status: respuesta.status,
                    statusText: respuesta.statusText,
                    errorResponse: errorMsg
                });
            }

        } catch (error) {
            itemsFallidos.push({
                item: item,
                error: error.message,
                status: 'Error de Red'
            });
        }
    }

    function actualizarProgreso(procesados, total) {
        const porcentaje = Math.round((procesados / total) * 100);
        document.getElementById('progreso').innerText = `Progreso: ${procesados} de ${total} (${porcentaje}%)`;
    }

    function mostrarResultadoFinal(total, fallidos) {
        document.getElementById('totalItems').innerText = `Total de ítems procesados: ${total}`;
        document.getElementById('itemsFallidosCount').innerText = fallidos.length;
        document.querySelector('.results').style.display = 'block';

        if (fallidos.length > 0) {
            const listaErroresDiv = document.getElementById('listaErrores');
            listaErroresDiv.innerHTML = '<p class="error">Detalles de los ítems fallidos:</p>';
            
            fallidos.forEach(falla => {
                const div = document.createElement('div');
                div.className = 'lista-errores';
                div.innerHTML = `
                    <p><strong>Ítem:</strong> ${JSON.stringify(falla.item)}</p>
                    ${falla.status ? `<p><strong>Estado:</strong> ${falla.status} ${falla.statusText || ''}</p>` : ''}
                    ${falla.error ? `<p><strong>Error de Red:</strong> ${falla.error}</p>` : ''}
                    ${falla.errorResponse ? `<p><strong>Respuesta de la API:</strong> ${falla.errorResponse}</p>` : ''}
                `;
                listaErroresDiv.appendChild(div);
            });
        }
    }

    function restablecerFormulario() {
        const btnCargar = document.getElementById('btnCargar');
        btnCargar.disabled = false;
        btnCargar.innerText = 'Iniciar Carga Masiva';
    }
</script>

</body>
</html>